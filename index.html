<script src="./libloader.user.js"></script>
<script src="./allfuncs.user.js"></script>
<script src="./indexeddb ls.user.js"></script>
<style>
  button,
  input {
    background-color: #777;
    color: #000;
  }

  body,
  head,
  html {
    background-color: #777;
  }
</style>
<button id="loadAllWordLists">setup</button>
<button id="startGame">start</button>
<button id="clearViewedWords">clear viewed words</button>
<h1 class="timer"></h1>
<h2 class="wordCount"></h2>
<br />
<div class="word"></div>

<script>
  class Timer {
    constructor(tickCb, maxTime, expireCb) {
      this.maxTime = maxTime || Infinity
      this.expireCb = expireCb
      this.tickCb = tickCb

      if ((maxTime && expireCb) || tickCb) {
        requestAnimationFrame(this.checkMaxTime.bind(this))
      }
      this.prevTime = performance.now()
      this.paused = true
      Object.defineProperty(this, "time", {
        get: () => {
          this.update(Reflect.get(this, "_time"))
          return Reflect.get(this, "_time")
        },
        set: (time) => {
          Reflect.set(this, "_time", time)
        },
      })
      Object.defineProperty(this, "expired", {
        get: () => {
          return this.time >= this.maxTime
        },
        set: () => {},
      })
      this.time = 0
    }
    checkMaxTime() {
      requestAnimationFrame(this.checkMaxTime.bind(this))
      if (this.paused && this.pausedLastFrame) {
        return
      }
      if (this.time >= this.maxTime) {
        this.pause()
        this.expireCb()
      }
      if (this.tickCb) {
        this.tickCb(this)
      }
      this.pausedLastFrame = this.paused
    }
    formatTimeLeft() {
      var minutes = Math.floor((this.maxTime - this.time) / 60000)
      var seconds = ((this.maxTime - this.time) % 60000) / 1000
      if (minutes == 0 && seconds <= 1) {
        return minutes + ":0" + seconds.toFixed(2)
      }
      seconds = Math.ceil(seconds)
      if (seconds < 10) {
        seconds = "0" + seconds
      }
      return minutes + ":" + seconds
    }
    formatTimeElapsed() {
      var minutes = Math.floor(this.time / 60000)
      var seconds = ((this.time % 60000) / 1000).toFixed(0)
      if (seconds < 10) {
        seconds = "0" + seconds
      }
      return minutes + ":" + seconds
    }
    update(time = this.time) {
      if (this.paused) {
        return
      }
      var now = performance.now()
      this.time = time + now - this.prevTime
      this.prevTime = now
    }
    restart() {
      this.prevTime = performance.now()
      this.time = 0
    }
    reset() {
      this.restart()
    }
    pause() {
      this.stop()
    }
    resume() {
      this.start()
    }
    stop() {
      if (this.paused) {
        return
      }
      this.update(Reflect.get(this, "_time"))
      this.paused = true
    }
    start() {
      if (!this.paused) {
        return
      }
      this.paused = false
      this.prevTime = performance.now()
    }
  }
  const a = loadlib("allfuncs")
  window.timer = new Timer(
    () => {
      a.qs(".timer").textContent = timer.expired
        ? "Time's up!"
        : timer.paused
        ? ""
        : timer.formatTimeLeft()
    },
    2 * 1000,
    () => {}
  )
  ;(async () => {
    const ls = await loadlib("indexeddb ls")("pyrimid")
    window.ls = ls
    ls.viewedLists ??= {}
    if (ls.folder) {
      try {
        await a.getfileperms(ls.folder)
      } catch (error) {
        await a.waitforclick()
        await a.getfileperms(ls.folder)
      }
      await setup()
    }
    a.qs("#loadAllWordLists").onclick = async (e) => {
      ls.folder = await a.getfolder(false)
      setup()
    }
    a.qs("#clearViewedWords").onclick = async (e) => {
      ls.viewedLists = {}
      setup()
    }
    a.qs("#startGame").onclick = async (e) => {
      window.chosenCats = []
      if (loadedData.length < 6) {
        return alert("You need to load at least 6 word lists")
      }

      for (var i = 0; i < 6; i++) {
        var selected = poprand(loadedData)
        chosenCats.push([selected.name, get7words(selected.text)])
      }
      showui()
    }
    function showui() {
      var dist = 800
      var padding = 10
      var offsetY = 100
      var offsetX = 10
      var size = dist / 3 - padding * 2
      a.qsa("#cat").forEach((e) => e.remove())
      var alldata = {
        width: size + "px",
        height: size + "px",
        backgroundColor: "#333",
        position: "absolute",
        id: "cat",
        display: "flex",
        justifyContent: "center",
        alignItems: "center",
        innerHTML: "<h2></h2>",
        textShadow: "0 0 15px white",
        onclick(e) {
          ls.viewedLists[chosenCats[this.catid][0]] ??= []
          showCat(chosenCats[this.catid])
          this.style.textShadow = "0 0 15px red"
          this.onclick = null
        },
        oncontextmenu(e) {
          e.preventDefault()
          if (confirm("show example?")) {
            a.qs(".word").textContent = poprand(
              chosenCats[this.catid][1]
            )
          }
        },
      }

      a.createelem(document.body, "div", {
        ...alldata,
        top: offsetY + "px",
        left: offsetX + dist / 3 + "px",
      })
      a.createelem(document.body, "div", {
        ...alldata,
        top: offsetY + dist / 3 + "px",
        left: offsetX + dist / 3 / 2 + "px",
      })
      a.createelem(document.body, "div", {
        ...alldata,
        top: offsetY + dist / 3 + "px",
        left: dist / 3 + dist / 3 / 2 + "px",
      })
      a.createelem(document.body, "div", {
        ...alldata,
        top: offsetY + (dist / 3) * 2 + "px",
        left: offsetX + "px",
      })
      a.createelem(document.body, "div", {
        ...alldata,
        top: offsetY + (dist / 3) * 2 + "px",
        left: offsetX + dist / 3 + "px",
      })
      a.createelem(document.body, "div", {
        ...alldata,
        top: offsetY + (dist / 3) * 2 + "px",
        left: offsetX + (dist / 3) * 2 + "px",
      })
      a.qsa("#cat").forEach((e, i) => {
        a.qs("h2", e).textContent = chosenCats[i][0]
          .replace(/[\-_]/g, " ")
          .replace(/ +/, " ")
        e.catid = i
      })
    }
    function showCat([name, words]) {
      ls.viewedLists[name].push(...words)
      a.qs(".wordCount").innerText = words.join("\n")
      timer.restart()
      timer.start()
    }
    function reroll(idx) {
      var selected = poprand(loadedData)
      chosenCats[idx] = [selected.name, get7words(selected.text)]
    }

    async function setup() {
      var files = []
      // time("a")
      // for await (var [name, file] of ls.folder.entries()) {
      //   if (file instanceof FileSystemFileHandle) {
      //     files.push(file.getFile())
      //     files.push({
      //       name: name.replace(/\.txt$/, ""),
      //       text: getLines(
      //         file.name,
      //         await a.readfile(await file.getFile())
      //       ),
      //     })
      //   }
      // }
      // timeEnd("a")
      document.querySelector(".wordCount").innerText =
        "LOADING WORDLISTS..."

      // time("a")
      var files = []
      for await (var [name, file] of ls.folder.entries()) {
        if (file instanceof FileSystemFileHandle) {
          files.push(file.getFile())
        }
      }
      files = await Promise.all(
        (
          await Promise.all(files)
        ).map(async (e) => {
          return new Promise(async (resolve, reject) => {
            const text = await a.readfile(e)
            resolve({
              name: e.name.replace(/\.txt$/, ""),
              text: getLines(e.name.replace(/\.txt$/, ""), text),
            })
          })
        })
      )
      // timeEnd("a")
      files = files.filter((e) => e.text.length >= 7)
      document.querySelector(
        ".wordCount"
      ).innerText = `loaded ${files.length} wordlists`
      window.loadedData = files
    }

    function getLines(name, data) {
      var lines = data
        .split("\n")
        .map((e) => e.trim())
        .filter((e) => e)
        .filter((e) => !(ls.viewedLists[name] ?? []).includes(e))
      // document.querySelector(".wordCount").innerText =// lines.length + " words"
      return lines
    }
    function get7words(list) {
      var shown = []
      for (var i = 0; i < 7; i++) {
        shown.push(poprand(list))
      }
      return shown
    }
    function poprand(arr) {
      var idx = a.randfrom(0, arr.length - 1)
      var selected = arr[idx]
      arr.splice(idx, 1)
      return selected
    }
  })()
</script>
